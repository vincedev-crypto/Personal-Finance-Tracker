<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Personal Finance Dashboard</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="/css/dashboard.css" rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
            const categoryChartData = /*[[${categoryData}]]*/ '{}';
            const monthlyChartData = /*[[${monthlyData}]]*/ '{}';
            window.logoutUrl = /*[[@{/logout}]]*/ '/logout';
            window.loggedInUsername = /*[[${session.loggedInUser != null ? session.loggedInUser.email : (#authentication != null and #authentication.principal != 'anonymousUser' and #authentication.principal instanceof T(com.appdev.Finance.model.CustomUserDetails) ? #authentication.principal.username : null)}]]*/ null;
        /*]]>*/
    </script>
</head>
<body class="dark-theme">

    <div th:replace="~{sidebar :: sidebar}"></div>

    <div class="main-content">
        <div class="container-fluid">
            <div class="dashboard-header mt-3 mb-4">
                <h2 class="text-center">Personal Finance Dashboard</h2>
            </div>

            <div th:if="${successMessage != null}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i><span th:text="${successMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${generalErrorMessage != null}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i><span th:text="${generalErrorMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${logoutMessage != null}" class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="fas fa-info-circle me-2"></i><span th:text="${logoutMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            <div th:if="${chartErrorMessage != null}" class="alert alert-warning alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i><span th:text="${chartErrorMessage}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
             <div th:if="${transactionListError != null}" class="alert alert-warning alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i><span th:text="${transactionListError}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <div class="row mb-4 justify-content-center">
                 <div class="col-lg-10 col-md-12">
                     <div class="card content-card">
                        <div class="card-body">
                            <h5 class="card-title text-center mb-3">
                                <i class="fas fa-coins me-2 text-primary"></i>Set Your Monthly Budget
                            </h5>
                            <p class="text-center text-secondary mb-3">
                                Your current budget is set to:
                                <strong class="text-headings" th:text="${currentBudget == null ? '₱0.00' : '₱' + #numbers.formatDecimal(currentBudget, 1, 2, 'POINT')}">₱0.00</strong>
                            </p>
                            <form th:action="@{/dashboard/budget/save}" method="post">
                                <label for="budgetAmountInput" class="form-label visually-hidden">Enter New Budget Amount</label>
                                <div class="input-group">
                                    <span class="input-group-text">₱</span>
                                    <input type="number" name="amount" step="0.01" min="0" class="form-control"
                                           id="budgetAmountInput"
                                           th:value="${currentBudget != null ? #numbers.formatDecimal(currentBudget, 1, 2, 'POINT') : '0.00'}" placeholder="Enter new budget amount" aria-label="Budget Amount" required>
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i>Save Budget</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4 justify-content-center">
                 <div class="col-lg-10 col-md-12">
                     <div class="card content-card">
                        <div class="card-body text-center">
                            <h5 class="card-title text-warning mb-3">
                                <i class="fas fa-chart-pie me-2"></i>Budget Usage (All Expenses vs Budget)
                            </h5>
                            <div class="progress" role="progressbar"
                                 th:attr="aria-valuenow=${expensePercentage},aria-valuemin=0,aria-valuemax=100"
                                 th:aria-label="${expensePercentage} + '% Budget Used'">
                                <div class="progress-bar bg-warning progress-bar-striped progress-bar-animated fw-bold"
                                     th:style="'width:' + ${expensePercentage} + '%'"
                                     th:text="${expensePercentage} + '%'">
                                </div>
                            </div>
                            <p class="mt-2 text-secondary small" th:if="${currentBudget != null && currentBudget <= 0}">
                                Set a budget above ₱0.00 to track usage.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-lg-6 mb-4 mb-lg-0">
                    <div class="card content-card h-100">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title text-info">
                                <i class="fas fa-chart-pie me-2"></i>Spending Analysis (All Categories - All Time)
                            </h5>
                            <div id="spendingByCategoryChart" class="chart-container chart-container-large"></div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card content-card h-100">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title text-success">
                                <i class="fas fa-chart-line me-2"></i>Expenses By Month (All Time)
                            </h5>
                             <div id="expensesByMonthChart" class="chart-container chart-container-large"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4 justify-content-center">
                <div class="col-lg-10 col-md-12">
                    <div class="card content-card summary-card-alt">
                        <div class="card-body">
                            <h5 class="card-title text-center mb-3">
                               <i class="fas fa-calendar-alt me-2"></i>Summary for <span th:text="${selectedMonth}" class="fw-bold text-headings">Selected Month</span>
                            </h5>
                            <div class="row text-center">
                                <div class="col-md-6 mb-2 mb-md-0">
                                    <h6>Total Income</h6>
                                    <p class="fs-5 text-success fw-bold"
                                       th:text="${selectedMonthTotalIncome == null ? '₱0.00' : '₱' + #numbers.formatDecimal(selectedMonthTotalIncome, 1, 2, 'POINT')}">₱0.00</p>
                                </div>
                                <div class="col-md-6 mb-2 mb-md-0">
                                    <h6>Total Expenses</h6>
                                    <p class="fs-5 text-danger fw-bold"
                                       th:text="${selectedMonthTotalExpenses == null ? '₱0.00' : '₱' + #numbers.formatDecimal(selectedMonthTotalExpenses, 1, 2, 'POINT')}">₱0.00</p>
                                </div>
                            </div>
                       </div>
                   </div>
               </div>
           </div>

           <div class="row mb-4 justify-content-center">
                <div class="col-lg-12">
                    <div class="card content-card">
                        <div class="card-header">
                             <i class="fas fa-list-ul me-2"></i>Transactions for <span th:text="${selectedMonth}" class="fw-bold"></span>
                        </div>
                        <div class="card-body">
                            <form th:action="@{/dashboard}" method="get" class="filter-form mb-3">
                                <input type="hidden" name="sortField" th:value="${sortField}" />
                                <input type="hidden" name="sortOrder" th:value="${sortOrder}" />
                                <div class="row g-2 align-items-end">
                                    <div class="col-md-3">
                                        <label for="dashboardSelectedMonth" class="form-label form-label-sm">View Month:</label>
                                        <select class="form-select form-select-sm" id="dashboardSelectedMonth" name="selectedMonth">
                                            <option th:each="monthName : ${availableMonths}"
                                                    th:value="${monthName}"
                                                    th:text="${monthName}"
                                                    th:selected="${monthName == selectedMonth}">
                                            </option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="dashboardKeyword" class="form-label form-label-sm">Keyword:</label>
                                        <input type="text" class="form-control form-control-sm" id="dashboardKeyword" name="keyword" th:value="${keyword}" placeholder="Description...">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="dashboardCategory" class="form-label form-label-sm">Category:</label>
                                        <select class="form-select form-select-sm" id="dashboardCategory" name="category">
                                            <option value="">All Categories</option>
                                            <option th:each="cat : ${availableCategoriesForFilter}" th:value="${cat}" th:text="${cat}" th:selected="${cat == selectedCategory}"></option>
                                        </select>
                                    </div>
                                     <div class="col-md-3">
                                        <label for="dashboardType" class="form-label form-label-sm">Type:</label>
                                        <select class="form-select form-select-sm" id="dashboardType" name="type">
                                            <option value="">All Types</option>
                                            <option value="Income" th:selected="${selectedType == 'Income'}">Income</option>
                                            <option value="Expense" th:selected="${selectedType == 'Expense'}">Expense</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row g-2 mt-1 align-items-end">
                                    <div class="col-md-3">
                                        <label for="dashboardStartDate" class="form-label form-label-sm">Start Date:</label>
                                        <input type="date" class="form-control form-control-sm" id="dashboardStartDate" name="startDate" th:value="${startDate}">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="dashboardEndDate" class="form-label form-label-sm">End Date:</label>
                                        <input type="date" class="form-control form-control-sm" id="dashboardEndDate" name="endDate" th:value="${endDate}">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="dashboardMinAmount" class="form-label form-label-sm">Min Amount (₱):</label>
                                        <input type="number" step="0.01" class="form-control form-control-sm" id="dashboardMinAmount" name="minAmount" th:value="${minAmount}">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="dashboardMaxAmount" class="form-label form-label-sm">Max Amount (₱):</label>
                                        <input type="number" step="0.01" class="form-control form-control-sm" id="dashboardMaxAmount" name="maxAmount" th:value="${maxAmount}">
                                    </div>
                                </div>
                                <div class="mt-2 d-flex justify-content-end gap-2">
                                    <a th:href="@{/dashboard(selectedMonth=${selectedMonth})}" class="btn btn-sm btn-outline-secondary" title="Clear All Filters for Current Month View"><i class="fas fa-times"></i> Clear Filters</a>
                                    <button type="submit" class="btn btn-sm btn-primary"><i class="fas fa-filter"></i> Apply Filters</button>
                                </div>
                            </form>

                            <hr th:if="${keyword != null or selectedType != null or selectedCategory != null or startDate != null or endDate != null or minAmount != null or maxAmount != null}">

                            <h6 class="mt-2" th:if="${keyword != null or selectedType != null or selectedCategory != null or startDate != null or endDate != null or minAmount != null or maxAmount != null}">
                                Filtered Results for <span th:text="${selectedMonth}" class="fw-bold text-headings"></span>:
                            </h6>

                            <div class="table-responsive">
                                <table class="table transactions-table-dark table-hover table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th>Desc. <a th:href="@{/dashboard(selectedMonth=${selectedMonth}, keyword=${keyword}, type=${selectedType}, category=${selectedCategory}, startDate=${startDate}, endDate=${endDate}, minAmount=${minAmount}, maxAmount=${maxAmount}, sortField='description', sortOrder=${sortField == 'description' && sortOrder == 'ASC' ? 'DESC' : 'ASC'})}"><i class="fas fa-sort"></i></a></th>
                                            <th>Cat. <a th:href="@{/dashboard(selectedMonth=${selectedMonth}, keyword=${keyword}, type=${selectedType}, category=${selectedCategory}, startDate=${startDate}, endDate=${endDate}, minAmount=${minAmount}, maxAmount=${maxAmount}, sortField='category', sortOrder=${sortField == 'category' && sortOrder == 'ASC' ? 'DESC' : 'ASC'})}"><i class="fas fa-sort"></i></a></th>
                                            <th>Type <a th:href="@{/dashboard(selectedMonth=${selectedMonth}, keyword=${keyword}, type=${selectedType}, category=${selectedCategory}, startDate=${startDate}, endDate=${endDate}, minAmount=${minAmount}, maxAmount=${maxAmount}, sortField='type', sortOrder=${sortField == 'type' && sortOrder == 'ASC' ? 'DESC' : 'ASC'})}"><i class="fas fa-sort"></i></a></th>
                                            <th class="text-end">Amount (₱) <a th:href="@{/dashboard(selectedMonth=${selectedMonth}, keyword=${keyword}, type=${selectedType}, category=${selectedCategory}, startDate=${startDate}, endDate=${endDate}, minAmount=${minAmount}, maxAmount=${maxAmount}, sortField='amount', sortOrder=${sortField == 'amount' && sortOrder == 'ASC' ? 'DESC' : 'ASC'})}"><i class="fas fa-sort"></i></a></th>
                                            <th>Date <a th:href="@{/dashboard(selectedMonth=${selectedMonth}, keyword=${keyword}, type=${selectedType}, category=${selectedCategory}, startDate=${startDate}, endDate=${endDate}, minAmount=${minAmount}, maxAmount=${maxAmount}, sortField='transactionDate', sortOrder=${sortField == 'transactionDate' && sortOrder == 'ASC' ? 'DESC' : 'ASC'})}"><i class="fas fa-sort"></i></a></th>
                                            <th>Receipt</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="tx : ${selectedMonthTransactionsList}"
                                            th:classappend="${#strings.equalsIgnoreCase(tx.type, 'Expense')} ? 'expense-row-highlight' : 'income-row-highlight'">
                                            <td th:text="${tx.description}"></td>
                                            <td th:text="${tx.category}"></td>
                                            <td th:classappend="${#strings.equalsIgnoreCase(tx.type, 'Expense')} ? 'text-danger fw-semibold' : 'text-success fw-semibold'">
                                                <i th:classappend="${#strings.equalsIgnoreCase(tx.type, 'Expense')} ? 'fas fa-arrow-down me-1' : 'fas fa-arrow-up me-1'"></i>
                                                <span th:text="${tx.type}"></span>
                                            </td>
                                            <td class="text-end fw-semibold"
                                                th:classappend="${#strings.equalsIgnoreCase(tx.type, 'Expense')} ? 'text-danger' : 'text-success'"
                                                th:text="${tx.amount == null ? '₱0.00' : '₱' + #numbers.formatDecimal(tx.amount, 1, 2, 'POINT')}">
                                            </td>
                                            <td th:text="${tx.transactionDate != null ? #temporals.format(tx.transactionDate, 'MMM dd, yyyy') : 'N/A'}"></td>
                                            <td>
                                                <div th:if="${tx.transactionFiles != null and not #lists.isEmpty(tx.transactionFiles)}">
                                                    <a th:each="file : ${tx.transactionFiles}"
                                                       href="#"
                                                       th:attr="data-file-url=@{/transactions/files/{fileId}(fileId=${file.id}, action='view')}, data-file-name=${file.originalFileName}, data-file-type=${file.contentType}"
                                                       class="badge bg-info text-dark text-decoration-none me-1 view-receipt-btn"
                                                       data-bs-toggle="modal" data-bs-target="#receiptModal"
                                                       th:title="'View ' + ${file.originalFileName}">
                                                        <i class="fas fa-eye me-1"></i>
                                                        <span th:text="${#strings.abbreviate(file.originalFileName, 15)}"></span>
                                                    </a>
                                                </div>
                                                </td>
                                        </tr>
                                        <tr th:if="${selectedMonthTransactionsList == null or selectedMonthTransactionsList.isEmpty()}">
                                            <td colspan="6" class="text-center text-secondary fst-italic py-3">
                                                <i class="fas fa-info-circle me-2"></i>No transactions recorded for <span th:text="${selectedMonth}" class="fw-bold text-headings">this month</span>
                                                <span th:if="${keyword != null or selectedType != null or selectedCategory != null or startDate != null or endDate != null or minAmount != null or maxAmount != null}" > with the current filters.</span>
                                                <span th:unless="${keyword != null or selectedType != null or selectedCategory != null or startDate != null or endDate != null or minAmount != null or maxAmount != null}" >.</span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="text-center mt-3 d-flex justify-content-between align-items-center"
                                 th:unless="${selectedMonthTransactionsList == null or selectedMonthTransactionsList.isEmpty()}">
                               <small class="text-secondary"
                                      th:text="${showingLimitedTransactions ? 'Showing first ' + #lists.size(selectedMonthTransactionsList) + ' of ' + totalTransactionsForMonthAfterFilter + ' transactions.' : 'Showing all ' + totalTransactionsForMonthAfterFilter + ' transactions.'}"></small>
                                <a th:href="@{/transactions(month=${selectedMonth}, category=${selectedCategory}, keyword=${keyword}, type=${selectedType}, startDate=${startDate}, endDate=${endDate}, minAmount=${minAmount}, maxAmount=${maxAmount})}"
                                   class="btn btn-sm btn-outline-secondary">
                                    <i class="fas fa-external-link-alt me-1"></i>View All on Transactions Page
                                </a>
                            </div>
                             <div class="text-center mt-2 text-secondary small"
                                  th:if="${selectedMonthTransactionsList != null and not selectedMonthTransactionsList.isEmpty() and showingLimitedTransactions}">
                                 (Limited view on dashboard for brevity)
                             </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content bg-dark text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="receiptModalLabel">View Receipt</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="receiptModalBody" style="min-height: 400px; display: flex; justify-content: center; align-items: center;">
                    <p>Loading receipt...</p>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/dashboard-chart.js" th:src="@{/js/dashboard-chart.js}"></script>
    <script th:src="@{/js/inactivity-timer.js}"></script>
    <script th:src="@{/js/notification.js}"></script>
    </body>
</html>