<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Transaction List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link th:href="@{/css/dashboard.css}" rel="stylesheet">
    <link th:href="@{/css/transaction.css}" rel="stylesheet">
</head>
<body class="dark-theme">
    <div class="app-container">
        <div th:replace="~{sidebar :: sidebar}"></div>

        <main class="main-content transactions-page-content">
            <div class="container content-within-main pt-4">
                <header class="page-header d-flex justify-content-between align-items-center mb-4">
                    <h1 class="dashboard-title-style mb-0">
                        <i class="fas fa-exchange-alt me-2"></i> Transactions
                    </h1>
                    <a th:href="@{/transactions/form}" class="btn btn-dashboard-primary">
                        <i class="fas fa-plus me-1"></i> Add Transaction
                    </a>
                </header>

                <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i><span th:text="${successMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i><span th:text="${errorMessage}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <div class="card content-card mb-4">
                    <div class="card-header">
                        <i class="fas fa-filter me-1"></i> Filter & Search Transactions
                    </div>
                    <div class="card-body">
                        <form id="filterForm" th:action="@{/transactions}" method="post" class="filter-form">
                            <input type="hidden" name="sortField" th:value="${sortField ?: 'transactionDate'}">
                            <input type="hidden" name="sortOrder" th:value="${sortOrder ?: 'DESC'}">

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="keyword" class="form-label">Keyword (Description)</label>
                                    <input type="text" class="form-control form-control-sm" id="keyword" name="keyword" th:value="${keyword}" placeholder="e.g., Groceries, Salary">
                                </div>
                                <div class="col-md-4">
                                    <label for="startDate" class="form-label">Start Date</label>
                                    <input type="date" class="form-control form-control-sm" id="startDate" name="startDate" th:value="${startDate}">
                                </div>
                                <div class="col-md-4">
                                    <label for="endDate" class="form-label">End Date</label>
                                    <input type="date" class="form-control form-control-sm" id="endDate" name="endDate" th:value="${endDate}">
                                </div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-3">
                                    <label for="filterType" class="form-label">Type</label>
                                    <select class="form-select form-select-sm" id="filterType" name="type">
                                        <option value="">All Types</option>
                                        <option value="Income" th:selected="${selectedType == 'Income'}">Income</option>
                                        <option value="Expense" th:selected="${selectedType == 'Expense'}">Expense</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="filterCategory" class="form-label">Category</label>
                                    <select class="form-select form-select-sm" id="filterCategory" name="category">
                                        <option value="">All Categories</option>
                                        <option th:each="cat : ${availableCategories}" th:value="${cat}" th:text="${cat}" th:selected="${cat == selectedCategory}"></option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="minAmount" class="form-label">Min Amount (₱)</label>
                                    <input type="number" step="0.01" class="form-control form-control-sm" id="minAmount" name="minAmount" th:value="${minAmount}" placeholder="e.g., 50.00">
                                </div>
                                <div class="col-md-3">
                                    <label for="maxAmount" class="form-label">Max Amount (₱)</label>
                                    <input type="number" step="0.01" class="form-control form-control-sm" id="maxAmount" name="maxAmount" th:value="${maxAmount}" placeholder="e.g., 500.00">
                                </div>
                            </div>
                             <div class="row g-3 mt-2">
                                <div class="col-md-3">
                                    <label for="filterMonth" class="form-label">Month</label>
                                    <select class="form-select form-select-sm" id="filterMonth" name="month">
                                        <option value="">All Months</option>
                                        <option th:each="m : ${T(java.time.Month).values()}"
                                                th:value="${m.getDisplayName(T(java.time.format.TextStyle).FULL, T(java.util.Locale).ENGLISH)}"
                                                th:text="${m.getDisplayName(T(java.time.format.TextStyle).FULL, T(java.util.Locale).ENGLISH)}"
                                                th:selected="${m.getDisplayName(T(java.time.format.TextStyle).FULL, T(java.util.Locale).ENGLISH) == selectedMonth}">
                                        </option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-3 d-flex justify-content-end gap-2">
                                <a href="#" id="clearFiltersLink" class="btn btn-dashboard-secondary btn-sm">
                                    <i class="fas fa-times me-1"></i> Clear Filters
                                </a>
                                <button type="submit" class="btn btn-dashboard-primary btn-sm">
                                    <i class="fas fa-search me-1"></i> Apply Filters
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <form id="sortForm" th:action="@{/transactions}" method="post" style="display: none;">
                    <input type="hidden" name="keyword" id="sortKeyword">
                    <input type="hidden" name="type" id="sortType">
                    <input type="hidden" name="category" id="sortCategory">
                    <input type="hidden" name="month" id="sortMonth">
                    <input type="hidden" name="startDate" id="sortStartDate">
                    <input type="hidden" name="endDate" id="sortEndDate">
                    <input type="hidden" name="minAmount" id="sortMinAmount">
                    <input type="hidden" name="maxAmount" id="sortMaxAmount">
                    <input type="hidden" name="sortField" id="sortSortField">
                    <input type="hidden" name="sortOrder" id="sortSortOrder">
                </form>


                <div class="content-card transactions-table-container">
                    <div class="table-responsive">
                        <table class="table transactions-table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>
                                        <a href="#" class="sort-link text-decoration-none text-white-50"
                                           data-sortfield="id"
                                           th:data-sortorder="${sortField == 'id' && sortOrder == 'ASC' ? 'DESC' : 'ASC'}">
                                            ID <i class="fas fa-sort"></i>
                                        </a>
                                    </th>
                                    <th>
                                        <a href="#" class="sort-link text-decoration-none text-white-50"
                                           data-sortfield="description"
                                           th:data-sortorder="${sortField == 'description' && sortOrder == 'ASC' ? 'DESC' : 'ASC'}">
                                            Description <i class="fas fa-sort"></i>
                                        </a>
                                    </th>
                                    <th class="text-end">
                                        <a href="#" class="sort-link text-decoration-none text-white-50"
                                           data-sortfield="amount"
                                           th:data-sortorder="${sortField == 'amount' && sortOrder == 'ASC' ? 'DESC' : 'ASC'}">
                                            Amount (₱) <i class="fas fa-sort"></i>
                                        </a>
                                    </th>
                                     <th>
                                        <a href="#" class="sort-link text-decoration-none text-white-50"
                                           data-sortfield="transactionDate"
                                           th:data-sortorder="${sortField == 'transactionDate' && sortOrder == 'ASC' ? 'DESC' : 'ASC'}">
                                            Date <i class="fas fa-sort"></i>
                                        </a>
                                    </th>
                                    <th>
                                        <a href="#" class="sort-link text-decoration-none text-white-50"
                                           data-sortfield="type"
                                           th:data-sortorder="${sortField == 'type' && sortOrder == 'ASC' ? 'DESC' : 'ASC'}">
                                            Type <i class="fas fa-sort"></i>
                                        </a>
                                    </th>
                                    <th>
                                        <a href="#" class="sort-link text-decoration-none text-white-50"
                                           data-sortfield="category"
                                           th:data-sortorder="${sortField == 'category' && sortOrder == 'ASC' ? 'DESC' : 'ASC'}">
                                            Category <i class="fas fa-sort"></i>
                                        </a>
                                    </th>
                                    <th> <a href="#" class="sort-link text-decoration-none text-white-50"
                                           data-sortfield="month"
                                           th:data-sortorder="${sortField == 'month' && sortOrder == 'ASC' ? 'DESC' : 'ASC'}">
                                        Month <i class="fas fa-sort"></i>
                                        </a>
                                    </th>
                                    <th>Receipt</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="transaction : ${transactions}"
                                    th:classappend="${#strings.equalsIgnoreCase(transaction.type, 'Expense')} ? 'expense-row-highlight' : 'income-row-highlight'">
                                    <td th:text="${transaction.id}"></td>
                                    <td th:text="${transaction.description}"></td>
                                    <td class="amount text-end"
                                        th:classappend="${#strings.equalsIgnoreCase(transaction.type, 'Expense')} ? 'text-danger' : 'text-success'"
                                        th:text="${#numbers.formatDecimal(transaction.amount, 1, 'COMMA', 2, 'POINT')}"></td>
                                    <td th:text="${transaction.transactionDate != null ? #temporals.format(transaction.transactionDate, 'MMM dd, yyyy') : 'N/A'}"></td>
                                    <td th:classappend="${#strings.equalsIgnoreCase(transaction.type, 'Expense')} ? 'text-danger fw-bold' : 'text-success fw-bold'"
                                        th:text="${transaction.type}"></td>
                                    <td th:text="${transaction.category}"></td>
                                    <td th:text="${transaction.month}"></td>
                                    <td> 
                                        <div th:if="${transaction.transactionFiles != null and not #lists.isEmpty(transaction.transactionFiles)}">
                                            <a th:each="file : ${transaction.transactionFiles}"
                                               th:href="@{/transactions/files/{fileId}(fileId=${file.id})}"
                                               target="_blank" class="badge bg-info text-dark me-1 view-receipt-btn-table" style="font-size: 0.75em;" th:title="${file.originalFileName}">
                                                <i class="fas fa-file-alt me-1"></i><span th:text="${#strings.abbreviate(file.originalFileName, 15)}"></span>
                                            </a>
                                        </div>
                                        <span th:unless="${transaction.transactionFiles != null and not #lists.isEmpty(transaction.transactionFiles)}" class="text-muted fst-italic">
                                            N/A
                                        </span>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(transactions)}">
                                    <td colspan="8" class="text-center fst-italic py-3">No transactions found matching your criteria.</td>
                                </tr>
                            </tbody>
                            <tfoot th:unless="${#lists.isEmpty(transactions)}">
                                <tr>
                                    <td colspan="2" class="text-end"><strong>Total for Filtered:</strong></td>
                                    <td id="total-amount" class="total-value text-end">
                                        <strong th:text="${#numbers.formatCurrency(totalAmount)}">0.0</strong>
                                    </td>
                                    <td colspan="5"></td> 
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:src="@{/js/transactions.js}"></script>
</body>
</html>
